<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Expedientes Judiciales</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuración de color para el encabezado judicial */
        .header-bg {
            background-color: #8b0000; /* Dark Red */
        }
        /* Estilos de tabla simples para Tailwind */
        .custom-table th, .custom-table td {
            border: 1px solid #e5e7eb;
            padding: 12px;
            text-align: left;
        }
        .custom-table th {
            background-color: #f3f4f6;
            font-weight: 600;
            color: #1f2937;
        }
    </style>
    <script>
        // Configuración de Tailwind para usar la fuente Inter y colores personalizados
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Arial', 'sans-serif'],
                    },
                    colors: {
                        'judicial-red': '#8b0000',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 font-sans min-h-screen flex flex-col">

    <!-- Caja de Mensajes Flotante (Reemplazo de alert()) -->
    <div id="messageBox" class="fixed top-5 right-5 p-4 rounded-xl text-white transition-opacity duration-300 opacity-0 z-50 shadow-lg" role="alert" aria-live="polite"></div>

    <header class="header-bg text-white text-center py-4 text-xl font-extrabold shadow-md">
        Consulta de Expedientes Judiciales
    </header>

    <div class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="w-full max-w-4xl mx-auto">
            
            <!-- Contenedor de Búsqueda -->
            <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-2xl border border-gray-100" id="searchContainer">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">Parámetros de Búsqueda</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Distrito Judicial -->
                    <div>
                        <label for="distrito" class="block text-sm font-medium text-gray-700 mb-1">Distrito Judicial (*)</label>
                        <select id="distrito" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-judicial-red focus:border-judicial-red transition duration-150">
                            <option>--SELECCIONAR</option>
                            <option>AMAZONAS</option><option>ANCASH</option><option>APURIMAC</option>
                            <option>AREQUIPA</option><option>AYACUCHO</option><option>CAJAMARCA</option>
                            <option>CALLAO</option><option>CAÑETE</option><option>CUSCO</option>
                            <option>DEL SANTA</option><option>HUANCAVELICA</option><option>HUANUCO</option>
                            <option>HUAURA</option><option>ICA</option><option>JUNIN</option>
                            <option>LA LIBERTAD</option><option>LAMBAYEQUE</option><option>LIMA</option>
                            <option>LIMA ESTE</option><option>LIMA NORTE</option><option>LIMA SUR</option>
                            <option>LORETO</option><option>MADRE DE DIOS</option><option>MOQUEGUA</option>
                            <option>PASCO</option><option>PIURA</option><option>PUNO</option>
                            <option>SAN MARTIN</option><option>SELVA CENTRAL</option><option>SULLANA</option>
                            <option>TACNA</option><option>TUMBES</option><option>UCAYALI</option>
                            <option>VENTANILLA - LIMA NOROESTE</option>
                        </select>
                    </div>

                    <!-- Instancia -->
                    <div>
                        <label for="instancia" class="block text-sm font-medium text-gray-700 mb-1">Instancia (*)</label>
                        <select id="instancia" onchange="updateEspecialidad()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-judicial-red focus:border-judicial-red transition duration-150">
                            <option>--SELECCIONAR</option>
                            <option>JUZGADO DE PAZ LETRADO</option>
                            <option>JUZGADO ESPECIALIZADO</option>
                            <option>JUZGADO MIXTO</option>
                            <option>SALA SUPERIOR</option>
                        </select>
                    </div>

                    <!-- Especialidad -->
                    <div>
                        <label for="especialidad" class="block text-sm font-medium text-gray-700 mb-1">Especialidad (*)</label>
                        <select id="especialidad" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-judicial-red focus:border-judicial-red transition duration-150">
                            <option>--SELECCIONAR</option>
                        </select>
                    </div>

                    <!-- Año -->
                    <div>
                        <label for="anio" class="block text-sm font-medium text-gray-700 mb-1">Año (*)</label>
                        <input type="number" id="anio" placeholder="Ejemplo: 2025" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-judicial-red focus:border-judicial-red transition duration-150" min="1900" max="2100">
                    </div>
                </div>
                
                <!-- N° Expediente -->
                <div class="mt-4">
                    <label for="expediente" class="block text-sm font-medium text-gray-700 mb-1">N° Expediente (*)</label>
                    <input type="text" id="expediente" placeholder="Ejemplo: 12345" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-judicial-red focus:border-judicial-red transition duration-150">
                </div>

                <!-- Captcha -->
                <div class="mt-6 flex flex-col sm:flex-row items-center gap-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                    <div class="text-sm font-medium text-gray-700 shrink-0">Verificación de seguridad:</div>
                    <div class="captcha flex items-center gap-4 flex-grow">
                        <span class="captcha-code text-2xl font-extrabold tracking-widest bg-gray-300 text-gray-800 px-4 py-2 rounded-lg select-none shadow-inner" id="captchaCode"></span>
                        <input type="text" id="captchaInput" placeholder="Ingrese el código" class="flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 uppercase" maxlength="5">
                    </div>
                </div>

                <!-- Botón de Consulta -->
                <button onclick="buscarExpediente()" class="w-full mt-6 bg-judicial-red hover:bg-red-700 text-white font-bold py-3 rounded-xl transition duration-300 shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-judicial-red focus:ring-opacity-50">
                    CONSULTAR EXPEDIENTE
                </button>
            </div>

            <!-- Contenedor de Resultados -->
            <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-2xl mt-8 border border-gray-100 result-container hidden" id="resultContainer">
                <button onclick="mostrarBusqueda()" class="inline-flex items-center bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-xl transition duration-150 mb-6">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                    Nueva Búsqueda
                </button>
                <h3 class="text-2xl font-semibold mb-4 text-gray-800">Resultado de Búsqueda</h3>
                <div id="tablaResultados" class="overflow-x-auto">
                    <!-- La tabla se inserta aquí -->
                </div>
                <div id="loadingIndicator" class="hidden text-center mt-6 text-lg font-medium text-judicial-red">Cargando resultados...</div>
            </div>

        </div>
    </div>

    <script>
        // --- Data y Mapeo ---
        const especialidades = {
            "--SELECCIONAR": ["--SELECCIONAR"],
            "JUZGADO DE PAZ LETRADO": ["--SELECCIONAR", "CIVIL", "CONTENCIOSO ADMINISTRATIVO", "FAMILIA CIVIL", "FAMILIA TUTELAR", "LABORAL"],
            "JUZGADO ESPECIALIZADO": ["--SELECCIONAR", "CIVIL", "FAMILIA CIVIL", "FAMILIA TUTELAR"],
            "JUZGADO MIXTO": ["--SELECCIONAR", "CIVIL", "CONTENCIOSO ADMINISTRATIVO", "FAMILIA CIVIL", "FAMILIA TUTELAR", "LABORAL"],
            "SALA SUPERIOR": ["--SELECCIONAR", "CIVIL", "CONTENCIOSO ADMINISTRATIVO", "FAMILIA CIVIL", "FAMILIA TUTELAR", "LABORAL"]
        };
        
        // La URL de Google Sheets se mantiene como la que proporcionaste
        const sheetURL = "https://docs.google.com/spreadsheets/d/1YykbF710wRkZze-A3Kf8OWt15GOR0DPznHP1Dp8VXEc/gviz/tq?tqx=out:json";


        // --- Utilidades ---
        
        /**
         * Muestra un mensaje flotante (reemplazo de alert()).
         * @param {string} message - El texto del mensaje.
         * @param {('error'|'success')} [type='error'] - El tipo de mensaje (afecta el color).
         */
        function showMessage(message, type = 'error') {
            const box = document.getElementById('messageBox');
            box.textContent = message;
            
            // Eliminar clases de estado previas
            box.classList.remove('bg-red-600', 'bg-green-600', 'opacity-100');
            box.classList.add('opacity-0'); // Ocultar temporalmente para resetear

            // Aplicar clases según el tipo
            if (type === 'error') {
                box.classList.add('bg-red-600');
            } else if (type === 'success') {
                box.classList.add('bg-green-600');
            }

            // Mostrar el mensaje
            requestAnimationFrame(() => {
                box.classList.add('opacity-100');
                box.classList.remove('opacity-0');
            });


            // Ocultar después de 4 segundos
            setTimeout(() => {
                box.classList.remove('opacity-100');
                box.classList.add('opacity-0');
            }, 4000);
        }

        // Generar captcha aleatorio
        function generarCaptcha() {
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            let code = "";
            for (let i = 0; i < 5; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
            document.getElementById("captchaCode").textContent = code;
            document.getElementById("captchaInput").value = ""; // Limpiar input del captcha
        }

        // Actualiza el select de Especialidad basado en la Instancia seleccionada
        function updateEspecialidad() {
            const instancia = document.getElementById("instancia").value;
            const especialidad = document.getElementById("especialidad");
            especialidad.innerHTML = "";
            
            const opts = especialidades[instancia] || especialidades["--SELECCIONAR"];

            opts.forEach(e => {
                const opt = document.createElement("option");
                opt.textContent = e;
                especialidad.appendChild(opt);
            });
        }
        
        // Inicializar al cargar la página
        document.addEventListener('DOMContentLoaded', () => {
            generarCaptcha();
            updateEspecialidad();
        });


        // --- Lógica de Búsqueda ---

        async function buscarExpediente() {
            // 1. Validar Captcha
            const codigo = document.getElementById("captchaCode").textContent;
            const entrada = document.getElementById("captchaInput").value.trim().toUpperCase();
            if (entrada !== codigo) {
                showMessage("Código de verificación incorrecto. Intente de nuevo.", 'error');
                generarCaptcha();
                return;
            }

            // 2. Validar campos obligatorios
            const distrito = document.getElementById("distrito").value;
            const instancia = document.getElementById("instancia").value;
            const especialidad = document.getElementById("especialidad").value;
            const anio = document.getElementById("anio").value.trim();
            const expediente = document.getElementById("expediente").value.trim();

            if (distrito === "--SELECCIONAR" || instancia === "--SELECCIONAR" || especialidad === "--SELECCIONAR" || !expediente || !anio) {
                showMessage("Por favor, complete todos los campos obligatorios (*).", 'error');
                generarCaptcha(); 
                return;
            }
            
            // Mostrar indicador de carga
            document.getElementById("loadingIndicator").classList.remove("hidden");
            document.getElementById("tablaResultados").innerHTML = "";


            // 3. Conectar y Buscar en Google Sheets
            try {
                const response = await fetch(sheetURL);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const text = await response.text();
                
                // Parsing específico para el formato JSONP de GSheets
                const jsonString = text.substring(47).slice(0, -2);
                const json = JSON.parse(jsonString);
                
                const rows = json.table.rows;
                const headers = json.table.cols.map(c => c.label);

                // --- BÚSQUEDA DINÁMICA DE COLUMNAS CLAVE ---
                const normalizedHeaders = headers.map(h => h.toUpperCase().trim());
                
                // Buscamos columnas que contengan 'EXPEDIENTE', 'EXP', 'N°', 'N' etc.
                let expIdx = normalizedHeaders.findIndex(h => h.includes('EXPEDIENTE') || h.includes('EXP'));
                // Buscamos columnas que contengan 'AÑO' o 'ANIO'
                let anioIdx = normalizedHeaders.findIndex(h => h.includes('AÑO') || h.includes('ANIO'));

                // Fallback: Si no se encuentran por nombre, asumimos los índices 0 y 1 (como en el código anterior)
                if (expIdx === -1) expIdx = 0;
                if (anioIdx === -1) anioIdx = 1;
                
                console.log(`Columnas detectadas: Expediente (Índice ${expIdx}), Año (Índice ${anioIdx})`);
                // ---------------------------------------------

                // 4. Filtrar datos usando los índices detectados
                const searchExpediente = expediente.toUpperCase();
                const searchAnio = anio.toUpperCase();

                const resultados = rows
                    .map(r => r.c.map(c => (c ? c.v : "")))
                    .filter(r => {
                        // Asegurar que la fila tiene suficientes columnas
                        if (r.length <= Math.max(expIdx, anioIdx)) return false; 
                        
                        const rowExpediente = (r[expIdx] || "").toString().toUpperCase();
                        const rowAnio = (r[anioIdx] || "").toString().toUpperCase();

                        // La búsqueda se mantiene con .includes() (coincidencia parcial)
                        return rowExpediente.includes(searchExpediente) && rowAnio.includes(searchAnio);
                    });

                document.getElementById("loadingIndicator").classList.add("hidden");

                if (resultados.length > 0) {
                    mostrarResultados(headers, resultados);
                    showMessage(`Se encontraron ${resultados.length} expedientes.`, 'success');
                } else {
                    mostrarResultados(headers, []);
                    showMessage("No se encontraron expedientes con los criterios proporcionados.", 'error');
                }

            } catch (e) {
                document.getElementById("loadingIndicator").classList.add("hidden");
                showMessage(`Error al conectar o procesar los datos de Drive. Verifique que la hoja esté 'Publicada en la web'. Detalle: ${e.message}`, 'error');
                console.error("Error al obtener o parsear Google Sheets:", e);
                mostrarBusqueda(); 
            }
        }

        // Muestra la tabla de resultados
        function mostrarResultados(headers, data) {
            const tablaResultadosDiv = document.getElementById("tablaResultados");
            tablaResultadosDiv.innerHTML = ""; 

            if (data.length === 0) {
                tablaResultadosDiv.innerHTML = '<div class="text-center p-8 bg-gray-50 border border-dashed border-gray-300 rounded-lg text-gray-600"><p class="font-semibold">No se encontraron expedientes que coincidan.</p><p class="text-sm mt-1">Verifique el N° Expediente, el Año y que su hoja de Drive esté publicada correctamente.</p></div>';
            } else {
                const tabla = document.createElement("table");
                tabla.className = "custom-table w-full";
                const thead = document.createElement("thead");
                const trh = document.createElement("tr");

                // Crear encabezados de columna
                headers.forEach(h => {
                    const th = document.createElement("th");
                    th.textContent = h;
                    trh.appendChild(th);
                });
                thead.appendChild(trh);
                tabla.appendChild(thead);

                // Crear filas de datos
                const tbody = document.createElement("tbody");
                data.forEach(row => {
                    const tr = document.createElement("tr");
                    tr.className = "hover:bg-gray-50 transition duration-150";
                    row.forEach(val => {
                        const td = document.createElement("td");
                        td.textContent = val;
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
                tabla.appendChild(tbody);
                tablaResultadosDiv.appendChild(tabla);
            }

            document.getElementById("searchContainer").classList.add("hidden");
            document.getElementById("resultContainer").classList.remove("hidden");
        }

        // Vuelve al formulario de búsqueda
        function mostrarBusqueda() {
            document.getElementById("resultContainer").classList.add("hidden");
            document.getElementById("searchContainer").classList.remove("hidden");
            document.getElementById("tablaResultados").innerHTML = "";
            generarCaptcha();
        }
    </script>
</body>
</html>
